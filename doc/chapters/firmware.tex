%
% firmware.tex
%
% Copyright (C) 2021 by SpaceLab.
%
% EPS 2.0 Documentation
%
% This work is licensed under the Creative Commons Attribution-ShareAlike 4.0
% International License. To view a copy of this license,
% visit http://creativecommons.org/licenses/by-sa/4.0/.
%

%
% \brief Firmware project chapter.
%
% \author Gabriel Mariano Marcelino <gabriel.mm8@gmail.com>
% \author Yan castro de Azeredo <yan.ufsceel@gmail.com>
%
% \institution Universidade Federal de Santa Catarina (UFSC)
%
% \version 0.1.0
%
% \date 2021/03/07
%

\chapter{Firmware} \label{ch:firmware}

\section{Sensors and Peripherals Variables}

A list of all the variables of EPS with their identification number (ID) and variable type that can be read from the sensors and peripherals is seen in the \autoref{tab:eps2-variables}.

\begin{longtable}[c]{cL{0.82\textwidth}l}
    \toprule[1.5pt]
    \textbf{ID} & \textbf{Name/Description} & \textbf{Type} \\
    \midrule
    0   & Time counter in millseconds                                       & uint32 \\
    1   & Temperature of the $\mu$C in K                                    & uint16 \\
    2   & EPS circuitry and Beacon MCU current in mA                        & uint16 \\
    \multirow{18}{*}{3} & Last reset cause: & \multirow{18}{*}{uint8} \\
        & - 0x00 = No interrupt pending                                     &        \\
        & - 0x02 = Brownout (BOR)                                           &        \\
        & - 0x04 = RST/NMI (BOR)                                            &        \\
        & - 0x06 = PMMSWBOR (BOR)                                           &        \\
        & - 0x08 = Wakeup from LPMx.5 (BOR)                                 &        \\
        & - 0x0A = Security violation (BOR)                                 &        \\
        & - 0x0C = SVSL (POR)                                               &        \\
        & - 0x0E = SVSH (POR)                                               &        \\
        & - 0x10 = SVML\_OVP (POR)                                          &        \\
        & - 0x12 = SVMH\_OVP (POR)                                          &        \\
        & - 0x14 = PMMSWPOR (POR)                                           &        \\
        & - 0x16 = WDT time out (PUC)                                       &        \\
        & - 0x18 = WDT password violation (PUC)                             &        \\
        & - 0x1A = Flash password violation (PUC)                           &        \\
        & - 0x1C = Reserved                                                 &        \\
        & - 0x1E = PERF peripheral/configuration area fetch (PUC)           &        \\
        & - 0x20 = PMM password violation (PUC)                             &        \\
        & - 0x22 to 0x3E = Reserved                                         &        \\
    4   & Reset counter                                                     & uint16 \\
    5   & -Y and +X sides solar panel voltage in mV                         & uint16 \\
    6   & -X and +Z sides solar panel voltage in mV                         & uint16 \\
    7   & -Z and +Y sides solar panel voltage in mV                         & uint16 \\
    8   & -Y side solar panel current in mA                                 & uint16 \\
    9   & +Y side solar panel current in mA                                 & uint16 \\
    10  & -X side solar panel current in mA                                 & uint16 \\
    11  & +X side solar panel current in mA                                 & uint16 \\
    12  & -Z side solar panel current in mA                                 & uint16 \\
    13  & +Z side solar panel current in mA                                 & uint16 \\
    14  & MPPT 1 duty cycle in \%                                           & uint8 \\
    15  & MPPT 2 duty cycle in \%                                           & uint8 \\
    16  & MPPT 3 duty cycle in \%                                           & uint8 \\
    17  & Main power bus voltage in mV                                      & uint16 \\
    18  & RTD0 temperature in K                                             & uint32 \\
    19  & RTD1 temperature in K                                             & uint32 \\
    20  & RTD2 temperature in K                                             & uint32 \\
    21  & RTD3 temperature in K                                             & uint32 \\
    22  & RTD4 temperature in K                                             & uint32 \\
    23  & RTD5 temperature in K                                             & uint32 \\
    24  & RTD6 temperature in K                                             & uint32 \\
    25  & Batteries voltage in mV                                           & uint16 \\
    26  & Batteries current in mA                                           & uint16 \\
    27  & Batteries average current in mA                                   & uint16 \\
    28  & Batteries accumulated current in mA                               & uint16 \\
    29  & Batteries charge in mAh                                           & uint16 \\
    30  & Battery monitor IC temperature in K                               & uint16 \\
    31  & Battery monitor status register                                   & uint8 \\
    32  & Battery monitor protection register                               & uint8 \\
    33  & Battery monitor cycle counter                                     & uint8 \\
    34  & Battery monitor Remaining Active-Absolute Capacity (RAAC) in mAh  & uint16 \\
    35  & Battery monitor Remaining Standby-Absolute Capacity (RSAC) in mAh & uint16 \\
    36  & Battery monitor Remaining Active-Relative Capacity (RARC) in \%   & uint8 \\
    37  & Battery monitor Remaining Standby-Relative Capacity (RSRC) in \%  & uint8 \\
    38  & Battery heater 1 duty cycle in \%                                 & uint8 \\
    39  & Battery heater 2 duty cycle in \%                                 & uint8 \\
    40  & Hardware version                                                  & uint8 \\
    \bottomrule[1.5pt]
    \caption{Variables and parameters of the EPS 2.0.}
    \label{tab:eps2-variables}
\end{longtable}

\section{Tasks}

A list of the firmware tasks can be seen in the \autoref{tab:firmware-tasks}.

\begin{table}[!h]
    \centering
    \begin{tabular}{lccccc}
        \toprule[1.5pt]
        \textbf{Name}          & \textbf{Priority} & \textbf{Initial delay [ms]} & \textbf{Period [ms]} & \textbf{Stack [bytes]} \\
        \midrule
        Startup (boot)         & Highest           & 0                           & Aperiodic            & 500                    \\
        Watchdog reset         & Lowest            & 0                           & 100                  & 128                    \\
        System reset           & High              & 0                           & 36000000             & 128                    \\
        Battery Heater Control & TBD               & 0                           & TBD                  & TBD                    \\
        Read sensors           & Medium            & 0                           & 60000                & 128                    \\
        CSP Server             & Lowest            & 0                           & 500                  & 1024                   \\
        MPPT                   & TBD               & TBD                         & TBD                  & TBD                    \\
        Beacon package         & TBD               & TBD                         & TBD                  & TBD                    \\
        \bottomrule[1.5pt]
    \end{tabular}
    \caption{Firmware tasks.}
    \label{tab:firmware-tasks}
\end{table}
